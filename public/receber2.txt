let ValorTotalAberto, subtotal1 = 0;
function carregarClientesFiltro() {
  limparNome();
  document.getElementById('formPresenta').style.display = 'none';
  document.getElementById('formListaReceberCliente').style.display = 'block';
  document.getElementById('selectCliFiltro').style.display = 'block';
  document.getElementById('client').style.display = 'block';  
}

function verParcelasDoCliente() {  
  const controleCliente = controleSeleCliente;
  if (!controleCliente) {
    alert('Selecione um cliente.');
    return;
  }
  fetch('/receber')
    .then(res => res.json())
    .then(receber => {
      const tabela = document.getElementById('tabelaReceberCliente');
      const tbody = tabela.querySelector('tbody');
      tbody.innerHTML = '';

      const parcelasDoCliente = receber.filter(p =>
        String(p.cliente_id) === String(controleCliente) && p.status === 'ABERTO'
      );

      if (parcelasDoCliente.length === 0) {
        tbody.innerHTML = `<tr><td colspan="14" style="text-align: center;">Nenhuma parcela encontrada para o cliente selecionado.</td></tr>`;
        document.getElementById('btnPagarParcelas').style.display = 'none';    
        return;
      }
       else
      {
        document.getElementById('btnPagarParcelas').style.display = 'block';    
      }

      let totalAberto = 0;
      parcelasDoCliente.forEach(parcela => {
        const valorAberto =
          parseFloat(parcela.valororiginal || 0) +
          parseFloat(parcela.multa || 0) +
          parseFloat(parcela.juros || 0) -
          parseFloat(parcela.valorpago || 0);
        totalAberto += valorAberto;

        const linha = document.createElement('tr');
        linha.innerHTML = `
          <td><input type="checkbox" class="checkParcela" value="${parcela.controle}" data-valor="${valorAberto.toFixed(2)}"></td>
          <td>${parcela.controle}</td>
          <td>${parcela.funcionario}</td>
          <td>${parcela.nomecliente}</td>
          <td>R$ ${parseFloat(parcela.valororiginal).toFixed(2)}</td>
          <td>R$ ${parseFloat(parcela.valorpago).toFixed(2)}</td>
          <td>${parcela.numeroparcela}</td>
          <td>${parcela.totalparcelas}</td>
          <td>${formatarDataBR(parcela.datacadastro)}</td>
          <td>${formatarDataBR(parcela.datavencimento)}</td>
          <td>R$ ${parseFloat(parcela.multa).toFixed(2)}</td>
          <td>R$ ${parseFloat(parcela.juros).toFixed(2)}</td>
          <td>${parcela.status}</td>
          <td><button class="btnExcluirrec" data-controle="${parcela.controle}">üóëÔ∏è</button></td>
        `;
        tbody.appendChild(linha);
      });
   
      const linhaTotalAberto = document.createElement('tr');
      linhaTotalAberto.innerHTML = `
        <td colspan="14" style="text-align: right; font-weight: bold; padding-top: 10px;">
          TOTAL EM ABERTO: R$ ${totalAberto.toFixed(2)}
        </td>
      `;
      tbody.appendChild(linhaTotalAberto);
      
      const linhaTotalSelecionadas = document.createElement('tr');
      linhaTotalSelecionadas.innerHTML = `
        <td colspan="14" style="text-align: right; font-weight: bold;" id="totalSelecionadas">
          TOTAL DE SELECIONADAS: R$ 0.00
        </td>
      `;
      tbody.appendChild(linhaTotalSelecionadas);
      
      document.querySelectorAll('.btnExcluirrec').forEach(botao => {
        botao.style.cssText = `
          background-color: blue; color: white;
          border: none; padding: 6px 12px;
          border-radius: 8px; cursor: pointer;
        `;
        botao.onclick = () => {
          const controle = botao.getAttribute('data-controle');
          removerReceberC(controle);
        };
      });

      function removerReceberC(controle) {    
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background-color: rgba(0, 0, 0, 0.5); display: flex;
        align-items: center; justify-content: center; z-index: 1000;
      `;
    
      const caixa = document.createElement('div');
      caixa.style.cssText = `
        background: white; padding: 20px; border-radius: 10px;
        text-align: center; max-width: 320px; width: 90%;
        box-shadow: 0 4px 10px rgba(0,0,0,0.2); overflow: hidden;
        font-family: sans-serif;
      `;
    
      const franja = document.createElement('div');
      franja.style.cssText = `
        height: 6px; background-color: #007BFF; width: 100%;
        margin: -20px -20px 10px -20px; border-top-left-radius: 10px; border-top-right-radius: 10px;
      `;
    
      const imagem = document.createElement('img');
      imagem.src = 'https://cdn-icons-png.flaticon.com/512/564/564619.png';
      imagem.alt = 'Advert√™ncia';
      imagem.style.cssText = 'width: 50px; margin-bottom: 10px;';
    
      const texto = document.createElement('p');
      texto.textContent = 'Deseja realmente excluir essa Parcela?';
      texto.style.marginBottom = '15px';
    
      const btnSim = document.createElement('button');
      btnSim.textContent = 'Sim';
      btnSim.style.cssText = `
        margin-right: 10px; padding: 8px 16px;
        background-color: #dc3545; color: white;
        border: none; border-radius: 5px; cursor: pointer;
      `;
    
      const btnCancelar = document.createElement('button');
      btnCancelar.textContent = 'Cancelar';
      btnCancelar.style.cssText = `
        padding: 8px 16px; background-color: #6c757d;
        color: white; border: none; border-radius: 5px;
        cursor: pointer;
      `;        
      caixa.appendChild(franja);
      caixa.appendChild(imagem);
      caixa.appendChild(texto);
      caixa.appendChild(btnSim);
      caixa.appendChild(btnCancelar);
      modal.appendChild(caixa);
      document.body.appendChild(modal);                  
      btnSim.onclick = () => {
        document.body.removeChild(modal);
    
        fetch(`/receber/${controle}`, { method: 'DELETE' })
          .then(res => {
            if (!res.ok) throw new Error();
            result = "Parcela removida com sucesso!";  
            showToast(result, 2500);                                                             
            resultado.style.color = "green";                
            resultado.style.display = "block";  
            esperar();         
            limparNome();
            document.getElementById('formPresenta').style.display = 'none'; 
            document.getElementById('formListaReceberCliente').style.display = 'none';
            document.getElementById('btnReCli').click();
            document.getElementById('btnReCliB').click();
          })
          .catch()  ;
      };        
      
      btnCancelar.onclick = () => {
        document.body.removeChild(modal);
      };
    } 
      
      const atualizarTotalSelecionadas = () => {
        let totalSelecionado = 0;
        const selecionadas = document.querySelectorAll('.checkParcela:checked');
        selecionadas.forEach(cb => {
          totalSelecionado += parseFloat(cb.getAttribute('data-valor') || 0);
          ValorTotalAberto = totalSelecionado
        });
        document.getElementById('totalSelecionadas').innerText =
          `TOTAL DE SELECIONADAS: R$ ${totalSelecionado.toFixed(2)}`;
           subtotal1 = totalSelecionado.toFixed(2)

        const checkTodos = document.getElementById('checkTodos');
        if (checkTodos) {
          checkTodos.checked = selecionadas.length === document.querySelectorAll('.checkParcela').length;
        }
      };
      
      document.querySelectorAll('.checkParcela').forEach(cb => {
        cb.addEventListener('change', atualizarTotalSelecionadas);
      });

      const checkTodos = document.getElementById('checkTodos');
      if (checkTodos) {
        checkTodos.checked = false;
        checkTodos.onchange = () => {
          const allCheckboxes = document.querySelectorAll('.checkParcela');
          allCheckboxes.forEach(cb => (cb.checked = checkTodos.checked));
          atualizarTotalSelecionadas();
        };
      }

      tabela.style.display = 'table';
    })
    .catch(err => {
      alert('Erro ao buscar parcelas: ' + err.message);
    });
}

  const btnPagar = document.getElementById('btnPagarParcelas');
if (btnPagar) {
  btnPagar.onclick = () => {
    const controleCliente = controleSeleCliente;

    if (!controleCliente) {
      const result = "Selecione um cliente!";
      showToast(result, 2500);
      return;
    }

    const selecionadas = document.querySelectorAll('.checkParcela:checked');
    if (selecionadas.length === 0) {
      const result = "Selecione ao menos uma parcela!";
      showToast(result, 2500);
      return;
    }
    pagarParcelas();
  };
}

   function pagarParcelas(controle) {    
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background-color: rgba(0, 0, 0, 0.5); display: flex;
        align-items: center; justify-content: center; z-index: 1000;
      `;
    
      const caixa = document.createElement('div');
      caixa.style.cssText = `
        background: white; padding: 20px; border-radius: 10px;
        text-align: center; max-width: 320px; width: 90%;
        box-shadow: 0 4px 10px rgba(0,0,0,0.2); overflow: hidden;
        font-family: sans-serif;
      `;
    
      const franja = document.createElement('div');
      franja.style.cssText = `
        height: 6px; background-color: #007BFF; width: 100%;
        margin: -20px -20px 10px -20px; border-top-left-radius: 10px; border-top-right-radius: 10px;
      `;
    
      const imagem = document.createElement('img');
      imagem.src = 'https://cdn-icons-png.flaticon.com/512/564/564619.png';
      imagem.alt = 'Advert√™ncia';
      imagem.style.cssText = 'width: 50px; margin-bottom: 10px;';
    
      const texto = document.createElement('p');
      texto.textContent = 'Tem certeza de que deseja quitar estas parcelas?';
      texto.style.marginBottom = '15px';
    
      const btnSim = document.createElement('button');
      btnSim.textContent = 'Sim';
      btnSim.style.cssText = `
        margin-right: 10px; padding: 8px 16px;
        background-color: #dc3545; color: white;
        border: none; border-radius: 5px; cursor: pointer;
      `;
    
      const btnCancelar = document.createElement('button');
      btnCancelar.textContent = 'Cancelar';
      btnCancelar.style.cssText = `
        padding: 8px 16px; background-color: #6c757d;
        color: white; border: none; border-radius: 5px;
        cursor: pointer;
      `;        
      caixa.appendChild(franja);
      caixa.appendChild(imagem);
      caixa.appendChild(texto);
      caixa.appendChild(btnSim);
      caixa.appendChild(btnCancelar);
      modal.appendChild(caixa);
      document.body.appendChild(modal);                  
      btnSim.onclick = () => {
        document.body.removeChild(modal);    
        FinalizarOperacao()       
        pagarParcelasSelecionadas()
      };        
      
      btnCancelar.onclick = () => {
        document.body.removeChild(modal);
      };  



  function pagarParcelasSelecionadas() {
  const controleCliente = controleSeleCliente;
  if (!controleCliente) 
    {
    result = "Selecione um Cliente!";  
    showToast(result, 2500);      
    return;
    } 

  const selecionadas = document.querySelectorAll('.checkParcela:checked');
  if (selecionadas.length === 0) 
    {
      result = "Selecione ao menos uma parcela!";  
      showToast(result, 2500);      
      document.getElementById('btnPagarParcelas').style.display = 'block';    
      return
    } 
    else
      {
        document.getElementById('btnPagarParcelas').style.display = 'block';    
      }

  const parcelasIds = [];
  let valorAbono = 0;

  selecionadas.forEach(cb => {
    parcelasIds.push(cb.value);
    valorAbono += parseFloat(cb.getAttribute('data-valor') || 0);
  });

  fetch(`/${controleCliente}/pagar-parcelas`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ parcelasIds, valorAbono })
  })
    .then(res => res.json())
    .then(data => {
      if (data.error) {        
        result = `Erro: ${data.error}`;  
        showToast(result, 2500);             
       
      } else {       
       // verParcelasDoCliente(); 
      }
    })
    .catch(err => {
      console.error('Erro ao pagar parcelas:', err);
      alert('Erro ao processar pagamento.');
    });
}
        
}

async function salvarLancamentosCaixaReceber() {  
  const cod_funcionario = codfuncionaR;
  const funcionario = funcionarioSelecionadoR;
  const cod_cliente = controleSeleCliente || 1;
  const cliente = nomeclienSele;
  const descricao = 'Recebimento de Parcelas';
  const datacadastro = new Date().toISOString().slice(0, 10);
  const valorDinheiro = totalGeral;    
  const debitoInput = parseFloat(document.getElementById('cartaoDebito').value) || 0;
  let especies
  if (dinheirov >0 && debitoInput ===0){
     especies = 'Dinheiro'     
  }
  else if (dinheirov ===0 && debitoInput >0){
     especies = 'Cart√£o Debito' 
  }    
    else{
     especies = 'Dinheiro + Cart√£o Debito'     
  }      
    
  if (valorDinheiro === 0) {
    alert('Informe um valor em dinheiro ou d√©bito.');
    return;
  }

  const movimentos = [];

  if (valorDinheiro > 0) {
    movimentos.push({
      cod_cliente,
      cliente,
      cod_funcionario,
      funcionario,
      cod_fornecedor: null,
      fornecedor: '',
      descricao: descricao + ' (Dinheiro)',
      datacadastro,
      especies: especies,
      valorentrada: valorDinheiro,
      valorsaida: 0
    });
  }  

  for (const movimento of movimentos) {
    try {
      const res = await fetch('/caixa', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(movimento)
      });

      if (!res.ok) {
        console.error('Erro ao salvar movimento:', await res.text());
      } else {
        console.log('Movimenta√ß√£o salva com sucesso:', movimento.especies);
      }
    } catch (err) {
      console.error('Erro de rede ao enviar movimenta√ß√£o:', err);
    }
  }
}

function limparFormularioReceberCliente() {
  window.scrollTo(0, 0);
  const tabela = document.getElementById('tabelaReceberCliente');
  const tbody = tabela.querySelector('tbody');
  if (tbody) tbody.innerHTML = '';
  document.getElementById('btnPagarParcelas').style.display = 'none';    

  // Zera checkbox geral
  const checkTodos = document.getElementById('checkTodos');
  if (checkTodos) checkTodos.checked = false;

  // Zera totais
  ValorTotalAberto = 0;
  const linhaTotal = document.createElement('tr');
  linhaTotal.innerHTML = `
    <td colspan="14" style="text-align: right; font-weight: bold;">
      TOTAL EM ABERTO: R$ 0.00
    </td>
  `;
  tbody.appendChild(linhaTotal);

  const linhaSelecionadas = document.createElement('tr');
  linhaSelecionadas.innerHTML = `
    <td colspan="14" style="text-align: right; font-weight: bold;" id="totalSelecionadas">
      TOTAL DE SELECIONADAS: R$ 0.00
    </td>
  `;
  tbody.appendChild(linhaSelecionadas);

  // Limpar select de cliente
  const selectCliente = document.getElementById('selectCliFiltro');
  if (selectCliente) selectCliente.value = '';

  // Limpar select de funcion√°rio
  const selectFuncionario = document.getElementById('selectFuncionarioReceber');
  if (selectFuncionario) selectFuncionario.value = '';
}

function FinalizarOperacao() {  
  window.scrollTo(0, 0);
  limparcalculos();
  document.getElementById('formPainel').style.display = 'block';   
  document.getElementById('formCalculos').style.display = 'block';      
  document.getElementById("dinheiro").focus(); 
  document.getElementById('cartaoCredito').style.display = 'none';
  document.getElementById('btnCancelar').style.display = 'none';      
  document.querySelector('label[for="cartaoCredito"]').style.display = 'none';
  document.getElementById('parceladoCredito').parentElement.style.display = 'none';

  descontov = document.getElementById('desconto');
  acrescimov = document.getElementById('acrescimo');
  const checkDesconto1 = document.getElementById('descontoPorcentagem');
  const checkAcrescimo1 = document.getElementById('acrescimoPorcentagem');
  const inputDesconto1 = document.getElementById('desconto');
  const inputAcrescimo1 = document.getElementById('acrescimo');
  checkDesconto1.addEventListener('change', () => {
  inputDesconto1.placeholder = checkDesconto1.checked ? "0%" : "R$ 0,00";
  CalcularDescAcres();
});

checkAcrescimo1.addEventListener('change', () => {
  inputAcrescimo1.placeholder = checkAcrescimo1.checked ? "0%" : "R$ 0,00";
  CalcularDescAcres();
});



function CalcularDescAcres() {
  const subtotal = parseFloat(document.getElementById('subtotal-valor')?.innerText || '0');
  const descInput = parseFloat(document.getElementById('desconto').value) || 0;
  const acresInput = parseFloat(document.getElementById('acrescimo').value) || 0;
  const descPorcento = document.getElementById('descontoPorcentagem').checked;
  const acresPorcento = document.getElementById('acrescimoPorcentagem').checked;
  const desconto = descPorcento ? (subtotal1 * descInput / 100) : descInput;
  const acrescimo = acresPorcento ? (subtotal1 * acresInput / 100) : acresInput;
  totalGeral = subtotal1 - desconto + acrescimo;
  descontov = desconto;
  acrescimov = acrescimo;
  subtotalv = subtotal1;
  if ((descPorcento && descInput > 99)) {
    showToast('Desconto inv√°lido: excede 99% ou resulta em total zerado.', 2500);
    document.getElementById('desconto').value = '';
    document.getElementById('acrescimo').value = '';
    CalcularDescAcres(); // rec√°lculo ap√≥s reset
    return;
  }
  document.getElementById('subtotal').innerText = subtotal.toFixed(2);
  document.getElementById('dcto').innerText = desconto.toFixed(2);
  document.getElementById('acres').innerText = acrescimo.toFixed(2);
  document.getElementById('total-geral').innerText = totalGeral.toFixed(2);
  document.getElementById('falta').value = totalGeral.toFixed(2);
  //desabilitarControles(totalGeral <= 0);
  //controlarBotoesMenu(!(totalGeral > 0 || vendas.length > 0));
}

// Eventos
document.getElementById('desconto').addEventListener('input', () => {
    CalcularDescAcres();
    if (dinheirov>0 || cartaoDebitov >0 )
    {
      calcularOperacao()
    }
});
document.getElementById('descontoPorcentagem').addEventListener('change', () => {  
  CalcularDescAcres();
  if (dinheirov>0 || cartaoDebitov >0)
    {
      calcularOperacao()
    }

});
document.getElementById('acrescimo').addEventListener('input', () => {  
  CalcularDescAcres();
  if (dinheirov>0 || cartaoDebitov >0 )
    {
      calcularOperacao()
    }
});
document.getElementById('acrescimoPorcentagem').addEventListener('change', () => {  
  CalcularDescAcres();
  if (dinheirov>0 || cartaoDebitov >0)
    {
      calcularOperacao()
    }
}); 

function arredondar(valor) {
  return Number(valor.toFixed(2));
}

function calcularOperacao() {
  const dinheiroInput = parseFloat(document.getElementById('dinheiro').value) || 0;
  const debitoInput = parseFloat(document.getElementById('cartaoDebito').value) || 0;
  const total = arredondar(totalGeral);  
  const dinheiro = arredondar(dinheiroInput);
  const debito = arredondar(debitoInput);
  const totalPago = arredondar(dinheiro + debito);
  dinheirov = dinheiro;
  const faltaEl = document.getElementById('falta');
  const trocoEl = document.getElementById('troco');  
  if (totalPago < total) {
    const falta = arredondar(total - totalPago);
    faltaEl.value = falta.toFixed(2);
    trocoEl.value = "0.00";
    showToast(`O valor total n√£o √© suficiente. Verifique os pagamentos. Total: R$ ${total.toFixed(2)} | Pago: R$ ${totalPago.toFixed(2)}`, 2000);
    return;
  }
  
  if (totalPago > total) {
    if (debito === 0) {
      const troco = arredondar(dinheiro - total);
      trocoEl.value = troco.toFixed(2);
      faltaEl.value = "0.00";
      return;
    } else {
      trocoEl.value = "0.00";
      faltaEl.value = "0.00";
      showToast("O valor total excede o valor da venda. Verifique os pagamentos.", 2500);
      return;
    }
  }

  // Valor pago exato
  trocoEl.value = "0.00";
  faltaEl.value = "0.00";
}


const camposPagamento1 = ['dinheiro', 'cartaoDebito'];

  camposPagamento1.forEach(id => {
  const campo1 = document.getElementById(id);
  if (campo1) {    
    campo1.addEventListener('blur', () => {
      calcularOperacao()
      console.log(`Campo ${id} perdeu o foco!`);
    });
    
    campo1.addEventListener('keydown', (event) => {
      if (event.key === 'Enter') {
        calcularOperacao()
        console.log(`Campo ${id} acionado com Enter!`);       
        const index = camposPagamento1.indexOf(id);
        const proximoCampo1 = document.getElementById(camposPagamento1[index + 1]);
        if (proximoCampo1) {
          proximoCampo1.focus();
        }
      }
    });
  }
});

const btnFinaliza1 = document.getElementById('btnFinalizar');
  btnFinaliza1.addEventListener('click', () => {
  FinalOperacao();    
  });
function FinalOperacao() {  
  const dinheiro = arredondar(parseFloat(document.getElementById('dinheiro').value) || 0);
  const debito = arredondar(parseFloat(document.getElementById('cartaoDebito').value) || 0);
  const total = arredondar(totalGeral);
  const totalPago = arredondar(dinheiro + debito);
  dinheirov = dinheiro;

  const faltaEl = document.getElementById('falta');
  const trocoEl = document.getElementById('troco');

  if (totalPago < total) {
    const falta = arredondar(total - totalPago);
    faltaEl.value = falta.toFixed(2);
    trocoEl.value = "0.00";
    showToast(`Pagamento insuficiente. Total: R$ ${total.toFixed(2)} | Pago: R$ ${totalPago.toFixed(2)}`, 2000);
    return;
  }
  
  if (totalPago > total) {
  
    if (debito === 0) {
      const troco = arredondar(dinheiro - total);
      trocoEl.value = troco.toFixed(2);
      faltaEl.value = "0.00";
    } else {
      trocoEl.value = "0.00";
      faltaEl.value = "0.00";
      showToast("Pagamento com valor excedente n√£o √© permitido com cart√£o. Ajuste os valores.", 2500);
      return;
    }
  }

  // Se chegou at√© aqui, tudo est√° OK: pagamento v√°lido
  trocoEl.value = trocoEl.value || "0.00";
  faltaEl.value = faltaEl.value || "0.00";

  // ‚úÖ Prosseguir com a opera√ß√£o
//   pagarParcelasSelecionadas();        
   salvarLancamentosCaixaReceber()
   result = "Pacelas quitadas com sucesso!";  
   showToast(result, 2500);                         
   limparFormularioReceberCliente()
   limparoperacao()
}

function limparoperacao()
{
    document.getElementById('troco').value = '0.00'
    document.getElementById('total-geral').innerText = '0.00';
    document.getElementById('dinheiro').value = ''
    document.getElementById('cartaoDebito').value = ''
    document.getElementById('falta').value = '0.00';  
    document.getElementById('desconto').value = ''
    document.getElementById('acrescimo').value = ''
    document.getElementById('subtotal').textContent = '0.00';
    document.getElementById('dcto').textContent = '0.00';
    document.getElementById('acres').textContent = '0.00';
    document.getElementById('formPainel').style.display = 'none';   
    document.getElementById('formCalculos').style.display = 'none';      
    document.getElementById('btnCancelar').style.display = 'block';      
    

}

}