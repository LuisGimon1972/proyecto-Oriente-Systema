let ValorTotalAberto = 0;
let subtotal1 = 0;
let dadosReceber = [];
let paginaAtual = 1;
const itensPorPagina = 14;

function carregarClientesFiltro() {
  limparNome();
  document.getElementById('formPresenta').style.display = 'none';
  document.getElementById('formListaReceberCliente').style.display = 'block';
  document.getElementById('selectCliFiltro').style.display = 'block';
  document.getElementById('client').style.display = 'block';  
}

function verParcelasDoCliente() {
  const controleCliente = controleSeleCliente; // Assume que controleSeleCliente está definido globalmente
  if (!controleCliente) {
    alert('Selecione um cliente.');
    return;
  }

  limparNome();
  document.getElementById('formPresenta').style.display = 'none';
  document.getElementById('formListaReceberCliente').style.display = 'block';

  fetch('/receber')
    .then(res => {
      if (!res.ok) throw new Error('Erro ao buscar parcelas do cliente');
      return res.json();
    })
    .then(receber => {
      // Filtra parcelas do cliente que estejam com status ABERTO
      dadosReceber = receber.filter(p => 
        String(p.cliente_id) === String(controleCliente) && p.status.toUpperCase() === 'ABERTO'
      );
      
      paginaAtual = 1;
      renderizarPaginaReceberCliente();
    })
    .catch(err => {
      alert('Erro ao listar parcelas do cliente: ' + err.message);
    });
}

function renderizarPaginaReceberCliente() {
  const tabela = document.getElementById('tabelaReceberCliente');
  const tbody = tabela.querySelector('tbody');
  tbody.innerHTML = '';

  // Calcula o slice para paginação
  const inicio = (paginaAtual - 1) * itensPorPagina;
  const fim = inicio + itensPorPagina;
  const dadosPagina = dadosReceber.slice(inicio, fim);

  ValorTotalAberto = 0;

  dadosPagina.forEach(parcela => {
    const tr = document.createElement('tr');

    // Exemplo de colunas - adapte conforme sua estrutura
    tr.innerHTML = `
      <td>${parcela.id}</td>
      <td>${parcela.cliente_id}</td>
      <td>${parcela.valor}</td>
      <td>${parcela.status}</td>
      <td>${parcela.data_vencimento}</td>
    `;

    tbody.appendChild(tr);

    // Soma valor total aberto
    ValorTotalAberto += Number(parcela.valor);
  });

  // Exemplo de mostrar o total aberto numa div/spam (adicione em seu HTML)
  document.getElementById('valorTotalAberto').textContent = ValorTotalAberto.toFixed(2);
}

// Configura listener para filtro geral de status (aberto/pago)
document.querySelectorAll('input[name="filtroStatus"]').forEach(radio => {
  radio.addEventListener('change', verreceber);
});

function verreceber() {
  limparNome();
  document.getElementById('formPresenta').style.display = 'none';
  document.getElementById('formListaReceber').style.display = 'block';

  fetch('/receber')
    .then(res => {
      if (!res.ok) throw new Error('Erro ao buscar conta a receber');
      return res.json();
    })
    .then(receber => {
      const statusSelecionado = document.querySelector('input[name="filtroStatus"]:checked').value;
      
      if (statusSelecionado === 'aberto') {
        dadosReceber = receber.filter(r => r.status.toLowerCase() === 'aberto');
      } else if (statusSelecionado === 'pago') {
        dadosReceber = receber.filter(r => r.status.toLowerCase() === 'pago');
      } else {
        dadosReceber = receber; // caso tenha opção 'todos' ou algo assim
      }

      paginaAtual = 1;
      renderizarPaginaReceber();
    })
    .catch(err => {
      alert('Erro ao listar receber: ' + err.message);
    });
}

function renderizarPaginaReceber() {
  // Similar ao renderizarPaginaReceberCliente, mas para a listagem geral
  const tabela = document.getElementById('tabelaReceber');
  const tbody = tabela.querySelector('tbody');
  tbody.innerHTML = '';

  const inicio = (paginaAtual - 1) * itensPorPagina;
  const fim = inicio + itensPorPagina;
  const dadosPagina = dadosReceber.slice(inicio, fim);

  dadosPagina.forEach(parcela => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${parcela.id}</td>
      <td>${parcela.cliente_id}</td>
      <td>${parcela.valor}</td>
      <td>${parcela.status}</td>
      <td>${parcela.data_vencimento}</td>
    `;
    tbody.appendChild(tr);
  });
}
